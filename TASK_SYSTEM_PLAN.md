# 后台任务系统实现方案

## 需求
用户希望在点击生成后，即使离开页面，生成任务也能继续执行，并且返回页面时可以查看当前进度。

## 实现方案

### 1. 数据库层面
- ✅ 已添加 `Task` 模型到 `models.py`
- ✅ 已创建数据库迁移脚本 `migrate_add_tasks_table.py`
- ✅ 已添加 `TaskResponse` schema

### 2. 后端任务服务
- ✅ 已创建 `task_service.py` 基础框架
- ⚠️ 需要完善任务执行逻辑（特别是进度更新）

### 3. API 端点
- ✅ 已添加任务查询接口（GET /api/tasks/{task_id}）
- ✅ 已添加小说任务列表接口（GET /api/novels/{novel_id}/tasks）
- ✅ 已添加活跃任务接口（GET /api/tasks/active）
- ⚠️ 需要修改现有的生成接口，改为异步任务模式

### 4. 前端实现
- ⚠️ 需要添加任务状态轮询
- ⚠️ 需要页面加载时恢复任务状态
- ⚠️ 需要显示任务进度

## 下一步工作

### 阶段1：完善后端任务系统
1. 修复 task_service.py 中的导入和逻辑
2. 实现任务进度回调机制
3. 修改生成接口，改为创建任务并后台执行

### 阶段2：前端任务管理
1. 创建任务状态服务
2. 实现任务轮询机制
3. 页面加载时检查并恢复任务状态
4. 显示任务进度UI

### 阶段3：测试和优化
1. 测试各种生成场景
2. 优化任务执行性能
3. 处理错误情况

## 注意事项
- 任务结果需要以 JSON 格式存储在数据库中
- 任务状态需要在执行过程中定期更新
- 需要考虑任务超时和失败重试机制
- 前端需要处理任务完成后的结果应用

