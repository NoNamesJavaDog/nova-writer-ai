# 性能测试指南

## 📋 测试脚本

使用 `test_performance.py` 进行性能测试。

## 🚀 运行测试

```bash
cd backend
python test_performance.py
```

## ✅ 测试内容

### 1. 向量生成性能
- 测试多个文本的向量生成时间
- 计算平均、最短、最长时间
- 验证API调用性能

### 2. 文本分块性能
- 测试长文本的分块处理速度
- 验证分块算法的效率

### 3. 向量存储性能
- 测试向量存储到数据库的时间
- 包括向量生成和数据库写入

### 4. 相似度检索性能
- 测试检索相似章节的响应时间
- 验证索引效果

### 5. 智能上下文检索性能
- 测试上下文推荐的响应时间
- 包括检索和格式化时间

## 📊 性能基准

### 预期性能指标

| 操作 | 预期时间 | 说明 |
|------|---------|------|
| 向量生成 | < 3秒/次 | 取决于API响应时间 |
| 文本分块 | < 0.01秒 | 本地处理，应该很快 |
| 向量存储 | < 1秒 | 包括向量生成和数据库写入 |
| 相似度检索 | < 0.5秒 | 使用HNSW索引 |
| 上下文检索 | < 2秒 | 包括检索和格式化 |

### 性能优化建议

1. **向量生成慢**
   - 检查网络延迟
   - 考虑使用本地模型（如果可用）
   - 检查API调用频率限制

2. **检索慢**
   - 确保HNSW索引已创建
   - 检查数据库性能
   - 考虑使用Redis缓存

3. **存储慢**
   - 使用后台任务处理
   - 批量处理多个章节
   - 优化数据库写入

## 📈 性能分析

测试脚本会输出：
- 每个操作的执行时间
- 平均、最短、最长时间
- 性能基准对比

## ⚠️ 注意事项

1. **需要数据库连接**：部分测试需要数据库连接
2. **需要有效数据**：存储和检索测试需要有效的章节ID和小说ID
3. **API调用**：向量生成测试会调用Gemini API，需要有效的API Key
4. **测试环境**：建议在测试环境运行，避免影响生产数据

## 🔧 自定义测试

可以修改测试脚本以适应你的需求：

```python
# 修改测试文本
test_texts = ["你的测试文本1", "你的测试文本2"]

# 修改分块大小
chunks = service._split_into_chunks(text, chunk_size=500)

# 修改检索参数
similar = service.find_similar_chapters(
    db=db,
    novel_id=novel_id,
    query_text=query_text,
    limit=10,  # 修改返回数量
    similarity_threshold=0.8  # 修改阈值
)
```

## 📚 相关文档

- **功能测试**：`TEST_VECTOR_FEATURES.md`
- **测试指南**：`TEST_EMBEDDING.md`


